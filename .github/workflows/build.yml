name: Build

on:
  push:
    branches:
      - main



jobs:
  build:
    name: Build and analyze
    runs-on: ubuntu-latest
    env:
     DB_URL_COVOIT: ${{ secrets.DB_URL_COVOIT }}
     DB_URL_COVOIT_TEST: ${{ secrets.DB_URL_COVOIT_TEST }}
     DB_USER_COVOIT: ${{ secrets.DB_USER_COVOIT }}
     DB_PASS_COVOIT: ${{ secrets.DB_PASS_COVOIT }}
     MJ_APIKEY_PUBLIC: ${{ secrets.MJ_APIKEY_PUBLIC }}
     MJ_APIKEY_PRIVATE: ${{ secrets.MJ_APIKEY_PRIVATE }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu' # Alternative distribution options are available.
      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      # Phase 1: Tests unitaires (Surefire)
      - name: Run unit tests
        run: mvn test

      # Phase 2: Tests d'int√©gration (Failsafe) avec base de donn√©es de test
      - name: Run integration tests
        env:
          SPRING_PROFILES_ACTIVE: test
        run: mvn verify -DskipTests

      - name: Send Discord notification on tests success
        if: success()
        run: |
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "‚úÖ Unit & Integration Tests Passed",
              "description": "All 226 unit tests and 5 integration tests passed successfully",
              "color": 3066993,
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          )
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"

      # Docker build and push steps
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: penumbriel
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            penumbriel/covoit:latest
            penumbriel/covoit:${{ github.sha }}
          platforms: linux/amd64,linux/arm64
      - name: Send Discord notification
        if: success()
        run: |
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "description": "üöÄ Covoit Backend app has been successfully built and pushed to [DockerHub](https://hub.docker.com/repository/docker/penumbriel/covoit/general)",
              "color": 3066993
            }]
          }
          EOF
          )
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"



            
  deploy:
             
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    
    
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          port: ${{ secrets.SERVER_PORT }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/covoit-app
            docker pull penumbriel/covoit:latest
            docker compose down
            DEPLOY_OUTPUT=$(docker compose up -d 2>&1)
            echo "$DEPLOY_OUTPUT"
            sleep 10
            if echo "$DEPLOY_OUTPUT" | grep -q "Started\|Created"; then
              echo "‚úÖ Container started successfully!"
              sleep 5
              echo "Final status:"
              docker compose ps
              echo "‚úÖ Deployment completed successfully!"
            else
              echo "‚ùå Deployment failed - container not started!"
              docker compose logs
              exit 1
            fi
            
      - name: Send Discord deploy notification
        if: success()
        run: |
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "description": "üéâ Covoit Backend app has been successfully deployed to [dev.goegilles.fr](https://dev.goegilles.fr)\n\nüìö You can checkout the API here: [Swagger UI](https://dev.goegilles.fr/swagger-ui/index.html)",
              "color": 3066993
            }]
          }
          EOF
          )
          curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
            
          
